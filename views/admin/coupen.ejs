<%- include("../partials/admin/header.ejs") %>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
  }
  th, td {
    border: none;
    padding: 8px;
    text-align: left;
  }
  th {
    background-color: #f8f9fa;
  }
  .table-action-icons {
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .search-bar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
  }
</style>
<body>
    <section class="content-main">
        <div class="content-header">
          <div>
            <h2 class="content-title card-title">Coupon List</h2>
          </div>
        </div>
        <div class="card mb-4">
          <header class="card-header">
            <div class="row align-items-center">
              <!-- Search bar (category filter) on the left side -->
              <div class="col-md-4 col-12 me-auto mb-md-0 mb-3">
                <form  action="/admin/coupen" id="couponSearchForm">
                  <input
                    type="text"
                    id="couponSearch"
                    class="form-control"
                    placeholder="Search Coupons..."
                    aria-label="Search Coupons"
                    name="searchTerm"
                  >
                </form>
              </div>
              <!-- Add Coupon button on the right side -->
              <div class="col-md-4 col-12 text-end">
                <a href="/admin/add-coupen" class="btn btn-secondary">Add Coupon</a>
              </div>
            </div>
            
          </header>
      
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Discount Amount</th>
                  <th>Min Order Value</th>
                  <th>Start Date</th>
                  <th>Expire Date</th>
                  <th>Usage Limit</th>
                  <th>IsActive</th>
                  <th>Action</th> <!-- Action column added -->
                </tr>
              </thead>
              <tbody id="tableBody">
                <% if(coupen && coupen.length > 0){%>

                    <% for(let i=0 ; i < coupen.length ; i++){ %>
                    <tr>
                      <td><%= coupen[i].code %></td>
                      <td><%= coupen[i].discountPercentage %></td>
                      <td><%= coupen[i].minOrderValue %></td>
                      <td><%= new Date(coupen[i].createdAt).toLocaleDateString("en-GB") %></td>
                      <td><%= new Date( coupen[i].expiredAt).toLocaleDateString("en-GB") %></td>
                      <td><%= coupen[i].usageLimit %></td>
                      <% if(coupen[i].isActive) { %>
                        <td>
                          <button class="btn btn-success btn-sm " onclick="inActive(event,'<%= coupen[i].code %>')">Active</button>
                        </td>
                        <% } else { %>
                        <td>
                          <button  class="btn btn-danger btn-sm " onclick="Active(event,'<%= coupen[i].code %>')">InActive</button>
                        </td>
                    <% } %>
                    
                    
                      <td class="table-action-icons " >
                        <a href="/admin/edit-coupon?id=<%= coupen[i]._id %>" class="btn btn-sm btn-warning">Edit</a>
                        <a onclick=" return deleteCoupen('<%= coupen[i]._id %>')" class="btn btn-sm btn-danger">Delete</a>
                      </td>
                    </tr>
                    <%}%>
                    <%}else{%>
                        <h3> Empty</h3> 
                        <%}%>
              </tbody>
            </table>
          </div>
        </div>
      </section>
</body>
<!-- SweetAlert2 CSS and JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

function search(e){
  e.preventDefault();
  const searchTerm = document.getElementById("couponSearch").value;
  fetch(`/admin/coupen?searchTerm=${searchTerm}`,{
    method:"GET",
    headers:{
      'Content-Type':'application/json'
    },
  })
  .then((res)=>{
    if(!res.ok){
      throw new Error ;
    }else{
      res.json()
    }
  })
  .then(()=> console.log("SEARCH ITEM"))
  .catch((res)=>{
    console.log("ERROR");
  })
}

  function deleteCoupen(id) {
  Swal.fire({
    icon: "warning",
    title: "Are You Sure?",
    showConfirmButton: true,
    showCancelButton: true,
    confirmButtonText: "Yes",
    cancelButtonText: "No",
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/admin/delete-coupen?id=${id}`, {
        method: "GET",
        headers: {
          'Content-Type': 'application/json',
        },
      })
      .then((res) => res.json())  // Parse the JSON response
      .then((data) => {
        if (data.success) {
          Swal.fire({
            icon: "success",
            title: "Successfully Deleted",
            text: data.message,
            timer: 1200,
            showCancelButton: false,
            showConfirmButton: false
          }).then(() => {
            // Optionally, reload the page to reflect changes
            location.reload();
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Failed to Delete",
            text: data.message,  // Display the error message from the response
            timer: 1200,
            showCancelButton: false,
            showConfirmButton: false
          });
        }
      })
      .catch((err) => {
        Swal.fire({
          icon: "error",
          title: "Error in Deleting Coupon",
          text: err.message,
          timer: 2000,
          showCancelButton: false,
          showConfirmButton: false
        });
      });
    } else if (result.isDismissed) {
      // User clicked "No" or dismissed the alert
      Swal.fire({
        icon: "info",
        title: "Cancelled",
        text: "Your item is safe.",
      });
    }
  });
}
function inActive(event, code) {
  event.preventDefault();
  console.log("InActive", code);

  fetch(`/admin/inActive?code=${encodeURIComponent(code)}`, {
    method: "GET",
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(res => res.json())
  .then(res => {
    if (res.success) {
      updateCouponTable(res.data);
    }
  })
  .catch(error => console.error("Error:", error));
}

function Active(event, code) {
  event.preventDefault();
  console.log("Active", code);

  fetch(`/admin/Active?code=${encodeURIComponent(code)}`, {
    method: "GET",
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(res => res.json())
  .then(res => {
    if (res.success) {
      updateCouponTable(res.data);
    }
  })
  .catch(error => console.error("Error:", error));
}

function updateCouponTable(coupenList) {
  let tableBody = document.getElementById("tableBody");
  tableBody.innerHTML = "";

  coupenList.forEach(coupen => {
    let tableData = `
      <tr>
        <td>${coupen.code}</td>
        <td>${coupen.discountPercentage}</td>
        <td>${coupen.minOrderValue}</td>
        <td>${new Date(coupen.createdAt).toLocaleDateString("en-GB")}</td>
        <td>${new Date(coupen.expiredAt).toLocaleDateString("en-GB")}</td>
        <td>${coupen.usageLimit}</td>
        <td>
          ${coupen.isActive 
            ? `<button class="btn btn-success btn-sm" onclick="inActive(event, '${coupen.code}')">Active</button>` 
            : `<button class="btn btn-danger btn-sm" onclick="Active(event, '${coupen.code}')">InActive</button>`}
        </td>
        <td class="table-action-icons">
          <a href="/admin/edit-coupon?id=${coupen._id}" class="btn btn-sm btn-warning">Edit</a>
          <a onclick="return deleteCoupen('${coupen._id}')" class="btn btn-sm btn-danger">Delete</a>
        </td>
      </tr>
    `;

    tableBody.insertAdjacentHTML('beforeend', tableData);
  });
}



</script>
<%- include("../partials/admin/footer.ejs") %>

