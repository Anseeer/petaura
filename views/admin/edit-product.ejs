<%- include("../partials/admin/header.ejs") %>

<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<style>
    .media-upload-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin: 20px 0;
}

.media-upload {
    display: flex;
    flex-direction: column;
    gap: 10px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
}

.form-label {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 5px;
    color: #333;
}

.input-upload {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.preview-image {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #f7f7f7;
    margin-bottom: 5px;
}

input[type="file"] {
    font-size: 14px;
}

.cropped-container {
    margin-top: 10px;
    display: none; /* Hidden until cropping is done */
}

.cropped-preview {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #f7f7f7;
}

.btn-save {
    width: fit-content;
    padding: 5px 10px;
    font-size: 14px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    align-self: flex-start;
}

.btn-save:hover {
    background-color: #0056b3;
}
.error-msg{
    color: red ;
}
</style>
<section class="content-main">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="content-header">
                <h2 class="content-title">Edit Product</h2>
            </div>
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Product Details</h4>
                </div>
                <div class="card-body">
                    <form method="post" action="/admin/editProduct?id=<%=product._id%>" enctype="multipart/form-data" id="editProductForm">
                        <!-- Product Title -->
                        <div class="mb-4">
                            <label for="product_name" class="form-label">Product Name</label>
                            <input type="text" placeholder="Type here" name="name" value="<%=product.name%>" class="form-control" id="product_name">
                            <div class="error-msg" id="err-1"></div>
                        </div>

                       <!-- Full Description -->
                        <div class="mb-4">
                             <label class="form-label">Description</label>
                             <textarea name="description" class="form-control" id="description" rows="4"><%= product.description %></textarea>
                             <div class="error-msg" id="err-2"></div>
                        </div>

                        
                            <div class="media-upload">
                                <label class="form-label">Product Media 1</label>
                                <div class="input-upload">
                                    <img src="<%=product.Image[0]%>" id="viewimg1" class="preview-image" alt="Original Image">
                                    <input type="file"  name="images" id="input1" value="<%=product.Image[1]%>" accept="image/png, image/jpg, image/jpeg" onchange="viewImage(event, 1)">
                                    <div class="error-msg" id="err-3"></div>
                                </div>
                                <button type="button" id="saveButton1" class="btn-save">Save</button>
                                <div class="cropped-container">
                                    <img src="" id="croppedImg1" class="cropped-preview">
                                </div>
                            </div>
                        
                            <div class="media-upload">
                                <label class="form-label">Product Media 2</label>
                                <div class="input-upload">
                                    <img src="<%=product.Image[1]%>" id="viewimg2" class="preview-image" alt="Original Image">
                                    <input type="file" name="images" id="input2" value="<%=product.Image[1]%>" accept="image/png, image/jpg, image/jpeg" onchange="viewImage(event, 2)">
                                    <div class="error-msg" id="err-4"></div>
                                </div>
                                <button type="button" id="saveButton2" class="btn-save">Save</button>
                                <div class="cropped-container">
                                    <img src="" id="croppedImg2" class="cropped-preview">
                                </div>
                            </div>
                        
                            <div class="media-upload">
                                <label class="form-label">Product Media 3</label>
                                <div class="input-upload">
                                    <img src="<%=product.Image[2]%>" id="viewimg3" class="preview-image" alt="Original Image">
                                    <input type="file" name="images" id="input3" value="<%=product.Image[2]%>" accept="image/png, image/jpg, image/jpeg" onchange="viewImage(event, 3)">
                                    <div class="error-msg" id="err-5"></div>
                                </div>
                                <button type="button" id="saveButton3" class="btn-save">Save</button>
                                <div class="cropped-container">
                                    <img src="" id="croppedImg3" class="cropped-preview">
                                </div>
                            </div>
                        
                          
                        <!-- Pricing -->
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <label class="form-label">Regular Price</label>
                                <input placeholder="$" type="text" id="regularPrice"  name="regularPrice" value="<%=product.regularPrice%>" class="form-control">
                                <div class="error-msg" id="err-6"></div>
                            </div> 
                            <div class="col-lg-6 mb-4">
                                <label class="form-label">Sale Price</label>
                                <input placeholder="$" type="text" name="salePrice" id="salePrice"  value="<%=product.salePrice%>" class="form-control">
                                <div class="error-msg" id="err-7"></div>
                            </div>
                        </div>

                        <!-- Additional Fields -->
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <label class="form-label">Color</label>
                                <input type="text" name="color" value="<%=product.color%>" placeholder="e.g., Red, Blue" id="color"  class="form-control">
                                <div class="error-msg" id="err-8"></div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <label class="form-label">Quantity</label>
                                <input type="number" placeholder="e.g., 50" id="quantity" value="<%=product.quantity%>" name="quantity" class="form-control">
                                <div class="error-msg"  id="err-10" ></div>
                            </div>
                        </div>

                        <!-- Product Offer -->
                        <div class="mb-4">
                            <label class="form-label">Product Offer</label>
                            <input type="text" placeholder="e.g., Buy 1 Get 1 Free" id="offer" value="<%=product.Offer%>" name="offer" class="form-control">
                            <div class="error-msg" id="err-9"></div>
                        </div>

                        <!-- Product Status -->
                        <div class="mb-4">
                            <label class="form-label">Product Status</label>
                            <select name="status"  class="form-select">
                                <option>Available</option>
                                <option>Out of Stock</option>
                                <option>Discounted</option>
                            </select>
                        </div>

                

                        <!-- Category and Tags -->
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <label class="form-label">Category</label>
                                <select name="category" class="form-select">
                                    <% for (let i = 0; i < category.length; i++) { %>
                                        <option value="<%= category[i].name %>" ><%= category[i].name %></option>
                                    <% } %>
                                </select>
                            </div>
                        </div>
                       

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary rounded">Submit Product</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>

    function viewImage1(event){
        document.getElementById("viewimg1").src = URL.createObjectURL(event.target.files[0]);
                console.log("lloooooooo");
        
            }
        
    function viewImage2(event){
        document.getElementById("viewimg1").src = URL.createObjectURL(event.target.files[0]);
    }

    function viewImage3(event){
//         document.getElementById("viewimg1").src = URL.createObjectURL(event.target.files[0]);
    }
     
    function viewImage(event, index) {
    const input = event.target;
    const reader = new FileReader();

    reader.onload = function () {
        const dataUrl = reader.result;
        const originalImage = document.getElementById("viewimg" + index);
        originalImage.src = dataUrl;
// 
        let cropper = new Cropper(originalImage, {
            aspectRatio: 1,
            viewMode: 1,
            guides: true,
            background: false,
            autoCropArea: 1,
            zoomable: true,
        });

        const saveButton = document.getElementById("saveButton" + index);
        saveButton.addEventListener("click", function () {
            const croppedCanvas = cropper.getCroppedCanvas();
            const croppedImage = document.getElementById("croppedImg" + index);

            // Generate cropped data URL
            const croppedDataUrl = croppedCanvas.toDataURL("image/png");
            croppedImage.src = croppedDataUrl;

            // Update input file element with cropped image
            croppedCanvas.toBlob((blob) => {
                const fileName = `cropped-img-${Date.now()}-${index}.png`;
                const imgFile = new File([blob], fileName, { type: "image/png" });

                const inputFile = document.getElementById("input" + index);
                const fileList = new DataTransfer();
                fileList.items.add(imgFile);
                inputFile.files = fileList.files;
            });

            // Hide the original image
            originalImage.style.display = "none";

            // Show cropped image container
            const croppedContainer = document.querySelector(
                "#croppedImg" + index
            ).parentNode;
            croppedContainer.style.display = "block";

            cropper.destroy(); // Destroy cropper after saving
        });
    };

    reader.readAsDataURL(input.files[0]);
}


    // Form validation 
    const name = document.getElementById("product_name");
    const description = document.getElementById("description");
    const images1 = document.getElementById("input1");
    const images2 = document.getElementById("input2");
    const images3 = document.getElementById("input3");
    const salePrice = document.getElementById("salePrice");
    const regularPrice = document.getElementById("regularPrice");
    const color = document.getElementById("color");
    const offer = document.getElementById("offer");
    const quantity = document.getElementById("quantity");
    const editProductForm = document.getElementById("editProductForm");
    const err1 = document.getElementById("err-1");
    const err2 = document.getElementById("err-2");
    const err3 = document.getElementById("err-3");
    const err4 = document.getElementById("err-4");
    const err5 = document.getElementById("err-5");
    const err6 = document.getElementById("err-6");
    const err7 = document.getElementById("err-7");
    const err8 = document.getElementById("err-8");
    const err9 = document.getElementById("err-9");
    const err10 = document.getElementById("err-10");

    function nameValidation(e){
        const nameVal = name.value;
        const namePattern = /^[A-Za-z$&\s-_]+$/;


        if(nameVal.trim() == ""){
            err1.style.display ="block";
            err1.innerHTML="Please Enter Valid Name";
        }

        else if(!namePattern.test(nameVal)){
            err1.style.display="block";
            err1.innerHTML = "Name Can Only Contain Alphebetics";
        }

        else{
            err1.style.display="none";
            err1.innerHTML="";
        }

    }

    function descriptionValidation(e){
        const descriptionVal = description.value;
        const descriptionPattern = /^(?=.*\bcat\b)(?=.*\bmice\b)(?=.*\btoy\b)(?=.*\bsqueaky\b)(?=.*\bsensors\b)(?=.*\bobstacles\b)(?=.*\binteractive\b)(?=.*\bbattery\b).*$ /;


        if(descriptionVal.trim()==""){
            err2.style.display="block";
            err2.innerHTML="Please Enter Description About The Product ";
       
        }else{
            err2.style.display="none";
            err2.innerHTML="";
        }
    }
    function input1Validation(e) {
    const imgVal = images1.value;
    const existingImg = "<%= product.Image[0] %>"; // Pass existing image path from server-side

    const imgPattern = /^.*\.(jpg|jpeg|png|gif|webp|bmp|JPG|JPEG|PNG|GIF|WEBP|BMP)$/;

    if (imgVal.trim() === "" && !existingImg) {
        err3.style.display = "block";
        err3.innerHTML = "File not uploaded";
    } else if (imgVal.trim() !== "" && !imgPattern.test(imgVal)) {
        err3.style.display = "block";
        err3.innerHTML = "Invalid file format";
    } else {
        err3.style.display = "none";
        err3.innerHTML = "";
    }
}

function input2Validation(e) {
    const imgVal = images2.value;
    const existingImg = "<%= product.Image[1] %>";

    const imgPattern = /^.*\.(jpg|jpeg|png|gif|webp|bmp|JPG|JPEG|PNG|GIF|WEBP|BMP)$/;

    if (imgVal.trim() === "" && !existingImg) {
        err4.style.display = "block";
        err4.innerHTML = "File not uploaded";
    } else if (imgVal.trim() !== "" && !imgPattern.test(imgVal)) {
        err4.style.display = "block";
        err4.innerHTML = "Invalid file format";
    } else {
        err4.style.display = "none";
        err4.innerHTML = "";
    }
}

function input3Validation(e) {
    const imgVal = images3.value;
    const existingImg = "<%= product.Image[2] %>";

    const imgPattern = /^.*\.(jpg|jpeg|png|gif|webp|bmp|JPG|JPEG|PNG|GIF|WEBP|BMP)$/;

    if (imgVal.trim() === "" && !existingImg) {
        err5.style.display = "block";
        err5.innerHTML = "File not uploaded";
    } else if (imgVal.trim() !== "" && !imgPattern.test(imgVal)) {
        err5.style.display = "block";
        err5.innerHTML = "Invalid file format";
    } else {
        err5.style.display = "none";
        err5.innerHTML = "";
    }
}

    function salePriceValidation(e){
        const saleVal = salePrice.value;
        const salePattern = /^\d+(\.\d{1,2})?$/;

        if(saleVal.trim()==""){
            err7.style.display="block";
            err7.innerHTML="Please Enter The SalePrice";
        }else if (!salePattern.test(saleVal)){
            err7.style.display="block";
            err7.innerHTML="Price Only Allowed Numnbers";
        }else{
            err7.style.display="none";
            err7.innerHTML=""
        }
    };

    function regularPriceValidation(e){
        const regVal = regularPrice.value;
        const regPattern = /^\d+(\.\d{1,2})?$/;

        if(regVal.trim()==""){
            err6.style.display="block";
            err6.innerHTML="Please Enter The regularPrice";
        }else if (!regPattern.test(regVal)){
            err6.style.display="block";
            err6.innerHTML="Price Only Allowed Numnbers";
        }else{
            err6.style.display="none";
            err6.innerHTML=""
        }
    };

    function colorValidation(e){
        const colorVal = color.value;
        const colorPattern = /^[a-zA-Z()\-_\s]+$/ ;

        if(colorVal.trim()==""){
            err8.style.display="block";
            err8.innerHTML="Please Enter Color";
        }else if(!colorPattern.test(colorVal)){
            err8.style.display="block";
            err8.innerHTML="Color only Allowed Alphebetics";
        }else{
            err8.style.display="none";
            err8.innerHTML=""
        }
    }

    function offerValidation(e){
        const offVal = offer.value;
        const offPattern = /^\d+(\.\d{1,2})?$/;

        if(offVal.trim()==""){
            err9.style.display="block";
            err9.innerHTML="Please Enter Offer";
        }else if (!offPattern.test(offVal)){
            err9.style.display="block";
            err9.innerHTML="Offer Only Allowed Number";
        }else{
            err9.style.display="none";
            err9.innerHTML=""
        }
    }

    function quantityValidation(e){
        const quanVal = quantity.value;
        const quanPattern = /^\d+(\.\d{1,2})?$/;

        if(quanVal.trim()==""){
            err10.style.display="block";
            err10.innerHTML="Please Enter Offer";
        }else if (!quanPattern.test(quanVal)){
            err10.style.display="block";
            err10.innerHTML="Offer Only Allowed Number";
        }else{
            err10.style.display="none";
            err10.innerHTML=""
        }

    }


    document.addEventListener("DOMContentLoaded",function(){
        editProductForm.addEventListener("submit",function(e){

            nameValidation();
            descriptionValidation();
            input1Validation();
            input2Validation();
            input3Validation();
            regularPriceValidation();
            salePriceValidation();
            colorValidation();
            offerValidation();
            quantityValidation();

           
            if( err1.innerHTML ||
                err2.innerHTML ||
                err3.innerHTML ||
                err4.innerHTML ||
                err5.innerHTML ||
                err6.innerHTML ||
                err7.innerHTML ||
                err8.innerHTML ||
                err9.innerHTML ||
                err10.innerHTML
            ){
                e.preventDefault();
            }
        });
    });



</script>

<%- include("../partials/admin/footer.ejs") %>
